{% extends "base.html" %}
{% set use_axios = true %}
{% set use_plotly = true %}
{% set use_leaflet = false %}
{% set use_bootstrap_css = true %}

{% block head_stylesheets %}
{{ super() }}
<!--<link href="static/css/mainapp.css" rel="stylesheet" media="screen">-->
{% endblock %}

{% block body_content %}
{{ super() }}
<div class="main d-flex flex-column" style="height:100%">
	<!-- TOOLBAR -->
	<div class="d-flex flex-row">
		<h4 id="segment-info">Segment
			<span id="current_segment_index">{%- if num_segments > 0 -%}1{%- else -%}0{%- endif -%}</span>
			of
			<span id="segments_count">{{ num_segments }}</span>
		</h4>
		<button id="prev-segment-btn" class='btn btn-default center' onclick="setPreviousSegment()"
				title="previous segment (keyboard: left arrow)" style="margin-left:.5rem">
			<span class='arrow-left'></span>
		</button>
		<button id="next-segment-btn" class='btn btn-default center' onclick="setNextSegment()"
				title="next segment (keyboard: right arrow)" style="margin-left:.5rem">
			<span class='arrow-right'></span>
		</button>

		<button class='btn btn-default' onclick="showSelectForm()" style="margin-left:.5rem">
			Select
		</button>
		<h4>Plots:</h4>
		<label title="{{ preprocessfunc_doc }}" style="margin-left:.5rem">
			<input type="checkbox" onchange="togglePreProcess()"> Pre-process
		</label>
		<label  style="margin-left:.5rem">
			<input type="checkbox" onchange="toggleAllComponentView()"> Show all orientations
		</label>
		<button class='btn btn-default' onchange="showConfigForm()" style="margin-left:.5rem">
			Config
		</button>
		<div style="margin-left:.5rem">
			<div id="info_message" style="display:none"></div>
			<div id="error_message" style="display:none; color:red"></div>
			<div id='loader' class='loader' style="display:none"></div>
		</div>
		<div id="db_url" style="margin-left:.5rem">
			DB: {{ title }}
		</div>
	</div>
	<!-- PLOTS CONTAINER -->
	<div class="d-flex flex-row" style="flex: 1 1 auto">
		<!--LEFT COLUMN PLOTS -->
		<div class='d-flex flex-column' style="flex: 0 0 50%" >
			<div style="flex: 1 1 50%; position:relative">
				<div id='plot-0' style="position:absolute;top:0;right:0;bottom:0;left:0;overflow:hidden"></div>
			</div>
			<div class="{%- if bottomPlots|length < 1 -%}d-none{%- else -%}d-flex{%- endif %} flex-column" style="flex:1 1 50%">
				<div style="flex: 1 1 auto; position:relative">
					<div id='plot-b' style="position:absolute;top:0;right:0;bottom:0;left:0;overflow:hidden"></div>
				</div>
				<div class="d-flex flex-row">
				 {% for obj in bottomPlots %}
					<button onclick="S2S.setPlotVisible('{{ obj.name }}')"
							style="margin-right:.5rem"
							class='btn btn-sm' title="{{obj.doc}}">
						{{ obj.name }}
					</button>
				{% endfor %}
				</div>
		 	</div>
		</div>
		<!--RIGHT COLUMN PLOTS -->
		<div class='d-flex flex-column' style="flex: 0 0 50%">
			 <!-- RIGHT TOP PLOT PANEL (WITH BUTTONS) -->
			<div class="{%- if rightPlots|length < 1 -%}d-none{%- else -%}d-flex{%- endif %} flex-row" style="flex:1 1 50%">
				<div style="flex: 1 1 auto; position:relative">
					<div id="plot-r" style="position:absolute;top:0;right:0;bottom:0;left:0;overflow:hidden"></div>
				</div>
				<div class="d-flex flex-column">
				{% for obj in rightPlots %}
					<button onclick="S2S.setPlotVisible('{{ obj.name }}')"
							style="margin-bottom:.5rem"
							class='btn btn-sm' title="{{obj.doc}}">
						{{ obj.name }}
					</button>
				{% endfor %}
				</div>
			</div>
			<!-- RIGHT BOTTOM PANEL (SEGMENT METADATA) -->
			<div class="d-flex flex-column" style="flex: 1 1 50%">
				<div>
					&#9432; Segment id (net.sta.loc.cha code): <span style="font-weight:bold; color:black">{ segData.mainInfo.seedId}}</span>,
					P-wave arrival: <span style="font-weight:bold; color:black">{ segData.mainInfo.arrivalTime}}</span>. Recorded
					event of magnitude <span style="font-weight:bold; color:black">{ segData.mainInfo.eventMag}}</span> is located
					&#8773; <span style="font-weight:bold; color:black">{ segData.mainInfo.eventDistanceKm}} Km</span> from the segment station.
					Full Segment metadata:
				</div>
				<div style="flex:1 1 auto; position:relative">
					<div style="position:absolute;top:0;right:0;bottom:0;left:0;overflow:auto">
						<table style="width:100%;">
							{% for class in classes %}
							<tr><td>
								<label style="white-space: nowrap;"
									   title="{{ class.label }}{%- if class.description -%}: {{ class.description }}{%- endif -%}">
									<input type="checkbox" onclick="toggleSegmentClassLabel(class.id)">
									{{ class.label }}
								</label>
							</td><td title="{{ class.label }}{%- if class.description -%}: {{ class.description }}{%- endif -%}"
									 style="text-overflow: ellipsis;white-space:nowrap;max-width:0;overflow:hidden" >
								({{ class.segments }} segments labelled) {{ class.description }}
							</td>
							{% endfor %}

							{% for mdata in metadata %}
							{% set name = mdata[0] %}
							{% set cssstyle = mdata[3] %}
							<tr style="{{ cssstyle }}">
								<td>{{ name }}</td>
								<td data-segment-attr="{{ name }}" style='width:100%'>N/A</td>
							</tr>
							{% endfor %}
						</table>
					</div>
				</div>
			</div>
		 </div>
	</div>
</div>

<!-- SELECTION FORM (move at the end so that it does not display long time, it's annoying otherwise) -->
<div id="select-form" style="display:none" class="popup alert">
	<!-- Select segments where: -->
	<a href="#" class="close" data-dismiss="alert" aria-label="close"
		onclick="closeSelectionForm();return false" style="font-size: xx-large;">&times;</a>
	<div class="center">
		<table id="table-select">
			<tr>
				<th>Attribute</th>
				<th><i>Select</i> expression
					<table class='note'>
							<tr><td>a b c</td><td>select segments whose attribute value is a, b or c</td></tr>
							<tr><td>[a, b]</td><td>select segments whose attribute value is between a and b (including endpoints)</td></tr>
							<tr><td>(a, b)</td><td>select segments whose attribute value is between a and b (excluding endpoints)</td></tr>
						<tr><td>!=a</td><td>select segments whose attribute value is not a</td></tr>
						<tr><td> =a &gt;a &gt;=a &lt;a &lt;=a</td><td>(same as above with different operators)</td></tr>
					</table>
				</th>
			</tr>
			{% for mdata in metadata %}
			{% set name = mdata[0] %}
			{% set type = mdata[1] %}
			{% set selection_expression = mdata[2] %}
			{% set cssstyle = mdata[3] %}
			<tr style="{{ cssstyle }}">
				<td>
					<span id="sss-{{ name }}"
						  class="{{ 'select-highlighted' if selection_expression.strip() else '' }}"
					>{{ name }}</span>
				</td>
				<td style='width:100%'>
					<input style='width:100%' type=text
						   value="{{ selection_expression }}"
						   data-segment-select-attr="{{ name }}"
						   oninput="this.value ? document.getElementById('sss-{{ name }}').classList.add('select-highlighted') : document.getElementById('sss-{{ name }}').classList.remove('select-highlighted')"
						   placeholder="{{ type }}"
					/>
				</td>
			</tr>
			{% endfor %}
		</table>
	</div>
	<div style='text-align:center'>
		<button class='btn btn-default' ng-click="selectSegments(selection.selExpr)">Select</button>
	</div>
</div>

<div id="config-form" class="popup alert" style="display:none">
	<!-- Config (.yaml file) -->
	<a href="#" class="close" data-dismiss="alert" aria-label="close" onclick="return false;"
		ng-click="closeConfigForm()" style="font-size: xx-large;">&times;</a>
	<div>
	Configuration editor (YAML syntax):
	</div>
	<div class="center" id='configEditor'>
	</div>
	<div style='text-align:center'>
		<button class='btn btn-default' ng-click="updateConfig()">Update</button>
	</div>
</div>
{% endblock %}
{% block after_body %}
	{{ super() }}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.17.0/ace.min.js"></script>
	<script type="text/javascript">
		var configEditor = ace.edit("configEditor");
		ace.config.set('basePath', 'https://pagecdn.io/lib/ace/1.4.8');
		// instead of doing so:
		// configEditor.setTheme("ace/theme/idle_fingers");
		// configEditor.session.setMode("ace/mode/yaml");
		// we set everything in the options dict
		// (for infor see: https://codepen.io/ryancat/pen/mMyvpx)
		var _fs = parseFloat(window.getComputedStyle(document.body).getPropertyValue('font-size'));
		configEditor.setOptions({
			wrap: true,
			fontSize: isNaN(_fs) ? 15 : _fs,
			mode: "ace/mode/yaml",
			theme: "ace/theme/idle_fingers",
			showLineNumbers: true,
	    });

		// adding keystrokes to segments selection:
		document.addEventListener("keyup", e => {
			if(e.ctrlKey || e.metaKey){ return; }
			var eTag  = (e.target.tagName || "").toLowerCase();
			var eType = (e.target.getAttribute('type') || "").toLowerCase();
			if((eTag == 'textarea') || (eTag == 'input' && eType == 'text')){ return; }
			var elm = null;
			if (e.keyCode + "" == '37') {  // left arrow
				elm = document.getElementById("prev-segment-btn");
			}else if (e.keyCode + "" == '39') {  // right arrow
				elm = document.getElementById("next-segment-btn");
			}
			if (elm){
				e.preventDefault();
				elm.click();
			}
		});
	</script>
	<script src="static/js/mainapp.js" defer></script>
<!--	<script type="text/javascript">-->
<!--		var S2S = new myApp(null, {{ bottomPlots|tojson }}, {{ rightPlots|tojson }});-->
<!--	</script>-->
	<script>
		function setInfoMessage(msg){
			var elm = document.getElementById('info_message');
			elm.style.display = msg ? '': 'none';
			elm.innerHTML = msg || "";
		}
		function setErrorMessage(msg){
			var elm = document.getElementById('error_message');
			elm.style.display = msg ? '': 'none';
			elm.innerHTML = msg || "";
		}
		function startRequest(){
			document.getElementById('db_url').style.display = 'none';
			document.getElementById('loader').style.display = '';
		}
		function endResponse(){
			document.getElementById('db_url').style.display = '';
			document.getElementById('loader').style.display = 'none';
		}
		axios.interceptors.request.use((config) => {
			startRequest();
			return config;
		}, (error) => {
			endResponse();
			setErrorMessage("Error: " + error);
			return Promise.reject(error);
		});
		axios.interceptors.response.use((response) => {
			endResponse();
			setErrorMessage("");
			return response;
		}, (error) => {
			endResponse();
			setErrorMessage("Error: " + error.message);
			return Promise.reject(error.message);
		});

		function getSegmentSelection(){
			var ret = {};
			var attrName = 'data-segment-select-attr';
			for (var elm of document.querySelectorAll(`input[${attrName}]`)){
				var key = elm.getAttribute(attrName);
				var value = elm.value;
				if(value.trim()){
					ret[key] = value.trim();
				}
			}
			return ret;
		}

		function setSegmentsSelection(){
			setInfoMessage("Selecting segments (please wait, it might take a while for large databases)");
			axios.post("/set_selection", data, {headers: {'Content-Type': 'application/json'}}).then(function(response) {
				var segmentsCount = response.data.num_segments;
				var errMsg = '';
				if (response.data.error_msg){
					errMsg = response.data.error_msg + ". Check the segment selection (if the problem persists, contact the software maintainers) ";
				}
				if (!errMsg && segmentsCount <= 0){
					if (selectionEmpty){
						errMsg = "No segment found, empty database";
					}else{
						errMsg = "No segment found with the current segment selection";
					}
				}
				if (errMsg){
					this.setWarning(errMsg);
					return;
				}
				SEGMENTS_COUNT = segmentsCount;
				setSegment(0);
				document.querySelectorAll('div[class=form]').style.display='none';  // close all forms
			});
		}

		const SEGMENTS_COUNT = {%- num_segments -%};
		const SELECTED_SEGMENT = 0;

		function setNextSegment(){
			var currentIndex = (SELECTED_SEGMENT + 1) % SEGMENTS_COUNT;
			setSegment(currentIndex);
		};

		function setPreviousSegment(){
			var currentIndex = SELECTED_SEGMENT == 0 ? SEGMENTS_COUNT - 1 : SELECTED_SEGMENT - 1;
			setSegment(currentIndex);
		};

		function setSegment(index){
			SELECTED_SEGMENT = index;
			refreshView(undefined, true);
		};


		{%- if num_segments > 0 -%}
		setSegment(0);
		{%- endif -%}
	</script>
{% endblock %}